<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../atom-google-sheet-adapter/atom-google-sheet-adapter.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../mdb-radio-list/mdb-radio-list.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="mdb-heatmap-behavior.html">
<link rel="import" href="mdb-heatmap.html">
<link rel="import" href="mdb-detailed-heatmap.html">
<link rel="import" href="mdb-heatmap-faq.html">

<!--
`mdb-heatmap-visualization`


@demo demo/index.html 
-->

<dom-module id="mdb-heatmap-visualization">
  <template>
    <style>
      :host {
        display: block;
        color: var( --mdb-secondary-text-dark, #000);
        background-color: var(--app-white-color, #fff);
        font-size: var(--mdb-medium-font, 14px);
        --mdb-radio-list-container: {
          @apply(--layout-horizontal);
        }
      }

      :host h2 {
        margin-top: 0;
        line-height: initial;
        font-size: 21px;
        font-weight: 400;
        color: var( --mdb-primary-text-dark, #000);
      }

      :host paper-tabs {
        margin-top: 0px;
        border-bottom: 1px solid var(--mdb-border-color, #444444);
      }

      :host paper-tab {
        padding: 0 var(--standar-spacing, 20px);
      }

      :host .summary {
        @apply(--layout-horizontal);
        max-height: 700px;
      }

      :host .column {
        -ms-flex: 1 1 33%;
        -webkit-flex: 1 1 33%;
        flex: 1 1 33%;
        overflow: auto;
        padding: var(--standard-spacing, 20px);
      }

      .summary .chart {
        padding: 10px 0 var(--standard-spacing, 20px) var(--standard-spacing, 20px);
        max-width: 335px;
      }

      :host .article-column {
        background-color: #fff9c3;
      }

      :host .column.faq-column {
        padding: 0;
        overflow: hidden;
        @apply(--layout-vertical);
      }

      .faq-column paper-tabs {
        margin: 0 var(--standard-spacing, 20px);
      }

      .faq-column iron-pages {
        padding: 0 var(--standard-spacing, 20px);
        flex: 1;
        overflow: auto;
      }

      :host .article {
        color: var(--mdb-primary-text-dark, #000);
      }

      .article h3,
      .article h2 {
        font-size: 16px;
        line-height: 1.2;
        margin-top: 0;
        margin-bottom: 10px;
      }

      .article h3 {
        font-weight: 500;
      }

      .article .article-title-help {
        font-size: 20px;
        font-weight: 400;
      }

      .article h2 {
        font-weight: bold;
      }

      :host .article ol {
        padding-left: 0;
      }

      :host .article-term {
        margin-bottom: var(--standard-padding, 20px);
      }

      :host iron-pages {
        padding: var(--standar-padding, 20px) 0 0;
      }


      :host .toBeCompliant {
        padding-top: 12px;
      }

      :host pre {
        white-space: pre-wrap;
        font-family: 'Roboto', 'Noto', sans-serif;
        margin-top: 0;
        margin-bottom: 5px;
      }

      :host .gdpr-metrics {
        @apply(--layout);
        border: 1px solid var(--mdb-border-color, #333);
        margin-top: var(--standard-padding, 20px);
      }

      :host .gdpr-metrics>div {
        @apply(--layout-flex);
        text-align: center;
      }

      :host .gdpr-metrics h2 {
        margin: 0;
        font-size: 40px;
        color: var(--mdb-accent-color-highlight, #5DA9DD);
        font-weight: 400;
        margin-top: 15px;
      }

      :host .gdpr-metrics p {
        font-size: 15px;
        font-weight: lighter;
        margin-top: 0;
      }

      :host mdb-radio-list {
        margin-top: var(--standard-padding, 20px);
      }

      :host mdb-radio-list paper-radio-button {
        font-size: 14px;
        @apply(--layout-flex);
        text-align: center;
        padding: 15px 10px;
      }

      :host paper-icon-button {
        color: var(--app-icon-color, #99a1b3);
        padding-right: 6px;
        height: 35px;
        width: 35px;
        padding-top: 0px;
        margin-top: -1px;
      }

      .checklist-item {
        @apply(--layout-horizontal);
        @apply(--layout-start);
      }

      .checklist-item pre {
        @apply(--layout-flex);
      }

      :host .checklist-item.completed paper-icon-button {
        color: #5bca52;
      }

      iron-pages {
        padding-top: 0px;
      }

      h3.glossary-header {
        color: var(--mdb-primary-text-dark);
        margin-top: 12px;
        font-weight: 500;
        margin-bottom: 2px;
      }

      .glossary-header::first-letter {
        text-transform: uppercase;
      }

      .glossary-header,
      .glossary-answer {
        font-size: 14px;
      }

      .details {
        padding: 10px var(--standard-spacing, 20px) 0px 0px;
      }

      .detailsTopBar {
        padding-left: 20px;
        display: flex;
        justify-content: space-between;
      }

      .detailsActionButtons {
        display: flex;
      }

      .detailsActionButtons mdb-radio-list {
        margin-top: 0px;
      }

      .leftSeparator {
        border-left: 1px solid var(--mdb-border-color);
        padding-left: 20px;
      }

      .rightSeparator {
        border-right: 1px solid var(--mdb-border-color);
        padding-right: 20px;
      }

      .detailsDataStats {
        padding-right: 20px;
        padding-left: 20px;
        padding-top: 3px;
      }

      .detailsDataStatsFigures {
        color: var(--mdb-accent-color-highlight, #5DA9DD);
        font-size: 16px;
      }

      .detailsDataStats .detailsDataStatsFigures:last-child {
        margin-left: 15px;
      }

      .details mdb-radio-list paper-radio-button {
        font-size: 12px;
        padding: 8px;
      }

      .syncStatus{
        text-align: center;
        color: #009688;
        padding-top: 10px;
      }

      .dateControlContainer{
        display: flex;
        justify-content: space-around;
        margin-top: 25px;
      }

      .dateControlContainer select{
        height: 40px;
        font-size: 18px;
        color: gray;
        text-indent: 10px;
        border: 1px solid var(--mdb-border-color, #444444);
        opacity: 0.8;
      }

      .dateControlContainer select.year{
        width: 100px;
      }

      .dateControlContainer select.month{
        width: 140px;
      }

      .dateControlContainer paper-icon-button{
        width: 50px;
        height: 50px;
      }
    </style>
    <atom-google-sheet-adapter key="{{key}}"></atom-google-sheet-adapter>

    <div class="legal-compliance-container">
      <iron-pages selected="{{selectedTab}}">
        <div class='summary'>
          <div class="column chart">
            <h2>Our GDPR Story</h2>
            <mdb-heatmap data="[[data]]"></mdb-heatmap>
            <div class="gdpr-metrics">
              <div>
                <h2>[[_countChecklistItemsDone(data)]]/[[_countChecklistItemsTotal(data)]]</h2>
                <p>Checklist items done</p>
              </div>
              <div>
                <h2>[[_countCompiledArticles(data)]]/[[data.length]]</h2>
                <p>Articles complied to</p>
              </div>
            </div>
            <div class='dateControlContainer'>
              <paper-icon-button icon="icons:chevron-left" on-tap="_prevMonth"></paper-icon-button>
              <select class='year'>
                  <template is='dom-repeat' items='[[_yearSelectionOptions]]'>
                    <option value='[[item]]'>[[item]]</option>
                  </template>
              </select>
              <select class='month' value="{{selectedDuration::change}}">
                <template is='dom-repeat' items='[[_monthSelectionOptions]]'>
                  <option value='[[item.key]]'>[[item.value]]</option>
                </template>
              </select>
              <paper-icon-button icon="icons:chevron-right" on-tap="_nextMonth"></paper-icon-button>
            </div>
            <!-- <mdb-radio-list selected="{{selectedDuration}}" size="small">
              <paper-radio-button name="feb">FEB</paper-radio-button>
              <paper-radio-button name="mar">MAR</paper-radio-button>
              <paper-radio-button name="apr">APR</paper-radio-button>
              <paper-radio-button name="may">MAY</paper-radio-button>
              <paper-radio-button name="jun">JUN</paper-radio-button>
              <paper-radio-button name="jul">JUL</paper-radio-button>
            </mdb-radio-list> -->
          </div>
          <div class="column faq-column">
            <paper-tabs class="faq-colum-tab" selected="{{selectedSummaryTab}}">
              <paper-tab>TO BE COMPLIANT</paper-tab>
              <paper-tab>FAQS</paper-tab>
              <paper-tab>GLOSSARY</paper-tab>
            </paper-tabs>
            <template is='dom-if' if="[[_isTabToBeCompliant(selectedSummaryTab)]]">
                <template is='dom-if' if="[[selectedArticle.toBeCompliant.length]]">
                  <div class='syncStatus'>
                    Status: [[_getSyncStatus(_pendingStatusSyncCount)]]
                  </div>
                </template>
            </template>
            <iron-pages selected="{{selectedSummaryTab}}">
              <div class="toBeCompliant">
                <template id="complianceRepeater" is="dom-repeat" items="[[selectedArticle.toBeCompliant]]">
                  <template is="dom-if" if="[[item.content]]">
                    <div class$="checklist-item [[_checkCompleted(item.complianceMet)]]">
                      <paper-icon-button icon="icons:check-circle" on-tap='_toggleComplianceCheck'></paper-icon-button>
                      <pre>[[item.content]]</pre>
                    </div>
                  </template>
                </template>
              </div>
              <div class="faq">
                <template id="faqRepeater" is="dom-repeat" items="[[selectedArticle.faqs]]" restamp>
                  <mdb-heatmap-faq question="[[item.title]]" answer="[[item.description]]"></mdb-heatmap-faq>
                </template>
              </div>
              <div class="glossary">
                <template is="dom-repeat" items="[[glossary]]">
                  <h3 class="glossary-header" id="[[_getId(item.term)]]">[[item.term]]</h3>
                  <div class="glossary-answer">[[item.definition]]</div>
                </template>
              </div>
            </iron-pages>
          </div>
          <div class="column article-column">
            <template is="dom-if" if="[[selectedArticle]]">
              <div class="article">
                <h3 class="article-description">[[selectedArticle.description]]</h3>
                <h2 class="article-title"> [[selectedArticle.name]]</h2>
                <h3 class="article-title-help">
                  [[selectedArticle.periodicTableInfo.fullname]]
                </h3>
                <pre>[[selectedArticle.articleContent]]</pre>
              </div>
            </template>
          </div>
        </div>
        <div class='details'>
          <div class='detailsTopBar'>
            <h2>Our GDPR Story</h2>
            <div class='detailsActionButtons'>
              <div>
                <mdb-radio-list class='rightSeparator' selected="{{selectedDetailOption}}" size="small">
                  <paper-radio-button name="track">TRACK</paper-radio-button>
                  <paper-radio-button name="understand">UNDERSTAND</paper-radio-button>
                </mdb-radio-list>
              </div>
              <div class='detailsDataStats'>
                <span class='detailsDataStatsFigures'>[[_countChecklistItemsDone(data)]]/[[_countChecklistItemsTotal(data)]]</span> Checklist items done
                <span class='detailsDataStatsFigures'>[[_countCompiledArticles(data)]]/[[data.length]]</span> Articles complied to
              </div>
              <div>
                <mdb-radio-list class='leftSeparator' selected="{{selectedDuration}}" size="small">
                  <paper-radio-button name="feb">FEB</paper-radio-button>
                  <paper-radio-button name="mar">MAR</paper-radio-button>
                  <paper-radio-button name="apr">APR</paper-radio-button>
                  <paper-radio-button name="may">MAY</paper-radio-button>
                  <paper-radio-button name="jun">JUN</paper-radio-button>
                  <paper-radio-button name="jul">JUL</paper-radio-button>
                </mdb-radio-list>
              </div>
            </div>
          </div>
          <mdb-detailed-heatmap articles="[[data]]" detail-type='{{selectedDetailOption}}' category-colors='[[categoryColors]]'></mdb-detailed-heatmap>
        </div>
      </iron-pages>
    </div>
  </template>

  <script>
    Polymer({

      is: 'mdb-heatmap-visualization',

      properties: {
        key: {
          type: String,
          observer: '_keyChanged',
        },

        modelSheet: {
          type: String,
          value: 'heat-map'
        },

        glossarySheet: {
          type: String,
          value: 'Glossary'
        },

        periodicTableSheet: {
          type: String,
          value: 'Periodic Table'
        },

        articleCategoryColorSheet: {
          type: String,
          value: 'Colors'
        },

        categoryColors: {
          type: Array,
          value: []
        },

        data: {
          type: Array,
          value: [],
          observer: '_dataChanged'
        },

        _data: {
          type: Array,
          value: [],
          observer: '_rawDataChanged'
        },

        glossary: {
          type: Array,
          value: []
        },

        selected: {
          type: Number,
          value: 1
        },

        selectedArticle: {
          type: Object,
          value: {},
          observer: '_selectedArticleChanged'
        },

        selectedDuration: {
          type: String,
          value: 'feb',
          observer: '_selectedDurationChanged'
        },

        selectedTab: {
          type: Number,
          value: 0
        },

        selectedSummaryTab: {
          type: Number,
          value: 0
        },

        selectedDetailOption: {
          type: String,
          value: 'track'
        },

        dataProvider : {
          type: Object
        },

        hashProvider: {
          type: Object
        },

        _pendingStatusSyncCount: {
          type: Number,
          value: 0
        },

        _monthMapping: {
          type: Object,
          value: {
            feb: 1,
            mar: 2,
            apr: 3,
            may: 4,
            jun: 5,
            jul: 6
          }
        },

        _monthSelectionOptions: {
          type: Array,
          value: [{key: 'feb', value: 'February'}, {key: 'mar', value: 'March'}, {key: 'apr', value: 'April'},
                  {key: 'may', value: 'May'}, {key: 'jun', value: 'June'}, {key: 'jul', value: 'July'}]
        },

        _yearSelectionOptions : {
          type: Array,
          value: function(){
            var currentYear = (new Date()).getFullYear();
            return [currentYear];
          }
        }
      },

      behaviors: [
        Mdb.heatmap
      ],

      listeners: {
        'article-changed': '_articleChanged'
      },

      attached: function () {
        this.addEventListener('go-to-glossary', function (e) {
          this._gotoGlossary();
          this.querySelector('#' + e.detail).scrollIntoView();
        });
      },

      _changeDuration: function(moveAhead = true){
        var allMonthKeys = Object.keys(this._monthMapping);
        var currentIndex = allMonthKeys.indexOf(this.selectedDuration);
        var requiredIndex = moveAhead ? currentIndex + 1: currentIndex - 1;

        if(requiredIndex == allMonthKeys.length)
          requiredIndex = 0;
        else if(requiredIndex == -1)
          requiredIndex = allMonthKeys.length - 1;

        this.set('selectedDuration', allMonthKeys[requiredIndex]);
      },

      _getSyncStatus: function(pendingCount){
        return pendingCount > 0 ? 'Syncing...' : 'Synced';
      },

      _nextMonth: function(){
        this._changeDuration(true);
      },

      _prevMonth: function(){
        this._changeDuration(false); 
      },

      _isTabToBeCompliant: function(tab){
        return tab == 0;
      },

      _toggleComplianceCheck: function(e){
        //TODO: get lastest compliance hashes before update
        var that = this;
        var item = e.model.item;
        var articleId = this.selectedArticle.id, month = this.selectedDuration;
        var complianceHashes = (this.selectedArticle.checkedComplianceHashes || {})[month] || [];
        var existingIndex = complianceHashes.indexOf(item.contentHash);
        if(existingIndex >= 0)
          complianceHashes.splice(existingIndex, 1);
        else
          complianceHashes.push(item.contentHash);

        this.set('_pendingStatusSyncCount', this._pendingStatusSyncCount + 1);
        this.dataProvider.updateCheckedArticleComplianceHashesAsync([{articleId: articleId, month: month, complianceHashes: complianceHashes}])
          .then(function(){
            return that._syncCheckedStatus();
          })
          .then(function(){
            that.set('_pendingStatusSyncCount', this._pendingStatusSyncCount - 1);
          });
      },

      _gotoGlossary: function () {
        this.selectedSummaryTab = 2;
      },

      _articleChanged: function (e) {
        this.selectedArticle = e.detail;
      },

      _selectedArticleChanged: function () {
        if (this.selectedArticle && this.selectedArticle.name) {
          var that = this;
          var heatMap = this.querySelector('mdb-heatmap');
          var index = this.data.findIndex(function (e) {
            return e.name === that.selectedArticle.name;
          });
          this.selected = index + 1;
          if (this.data && this.data.length && heatMap) {
            heatMap._highlight(this.selectedArticle);
          }
        }
      },

      _checkCompleted: function (complianceMet) {
        return complianceMet ? 'completed' : '';
      },

      _keyChanged: function () {
        if (this.key) {
          var that = this;
          this.fire('dataload-begin');
          this._fetchData()
            .then(function (data) {
              that.dataLoaded = true;
              var model = data[0], glossary = data[1];
              var articles = that._transform(model);        
              setTimeout(function () {
                that.categoryColors = data[3];
                that._attachAdditionalInfoToArticles(articles, data[2], data[3]);
                that.set('_data', articles);
                that.set('glossary', glossary);
                that.set('_pendingStatusSyncCount', that._pendingStatusSyncCount + 1);
                that._syncCheckedStatus()
                  .then(function(){
                    that.set('_pendingStatusSyncCount', that._pendingStatusSyncCount - 1);
                  });
              }, 0);
            })
            .then(function () {
              that.fire('dataload-end');
            });
        }
      },

      _syncCheckedStatus: function(){
        var that = this;
        var allArticleIds = this._data.map(function(_article){
          return _article.id;
        });
        var allMonths = Object.keys(this._monthMapping);

        return this.dataProvider.getCheckedArticleComplianceHashesAsync(allArticleIds, allMonths)
          .then(function(articleComplianceHashes){
            that._mergeComplianceHashesWithArticles(that._data, articleComplianceHashes);
            that._updateComplianceStatusForDuration();
          })
          .catch(function(){});
      },

      _updateComplianceStatusForDuration: function(){
        var that = this;
        
        if(!this.selectedArticle || !this.selectedArticle.toBeCompliant)
          return;
        that.selectedArticle.toBeCompliant.forEach(function(compliance){
            var complianceMet = ((that.selectedArticle.checkedComplianceHashes || {})[that.selectedDuration] || []).find(function(_hash){
              return _hash == compliance.contentHash;
            });
            if(complianceMet)
              compliance.complianceMet = true;
            else
              compliance.complianceMet = false;
        });

        that.set('selectedArticle', JSON.parse(JSON.stringify(that.selectedArticle)));
      },

      _mergeComplianceHashesWithArticles: function(articles, articleComplianceHashes){
        (articleComplianceHashes || []).forEach(function(articleComplianceHash){
          var match = articles.find(function(_article){
            return _article.id == articleComplianceHash.articleId;
          });

          if(!match)
            return;

          match.checkedComplianceHashes = articleComplianceHash.checkedComplianceHashes;
        });
      },

      _rawDataChanged: function () {
        this.set('data', this._getDurationData(this.selectedDuration));
      },

      _getDurationData: function (duration) {
        var that = this;

        return this._data
          .map(function (e) {
            e.toBeCompliant
              .map(function (c) {
                c.status = c['status' + that._monthMapping[duration]];
                return c;
              });
            e.status = that._calculateStatus(e);
            e.color = that._calculateColor(e.status);
            return e;
          });
      },

      _selectedDurationChanged: function () {
        if (this.selectedArticle.name) {
          this.set('data', this._getDurationData(this.selectedDuration));
          this.set('selectedArticle', JSON.parse(JSON.stringify(this.data[this.selected - 1])));
          this._updateComplianceStatusForDuration();
        }
      },

      _fetchData: function () {
        var that = this,
          adapter = this.querySelector('atom-google-sheet-adapter');

        var dataPromises = [adapter.read(that.modelSheet), adapter.read(that.glossarySheet),
        adapter.read(that.periodicTableSheet), adapter.read(that.articleCategoryColorSheet)];

        return Promise.all(dataPromises);
      },

      _dataChanged: function () {
        if (this.data && this.data.length) {
          var heatMap = this.querySelector('mdb-heatmap');
          if (heatMap) {
            heatMap.render();
          }
          this.set('selectedArticle', this.data[this.selected - 1]);
        }
      },

      _attachAdditionalInfoToArticles: function (articles, periodicTable, colors) {
        if ((articles || []).length == 0 || (periodicTable || []).length == 0)
          return;

        articles.forEach(function (article) {
          var periodicTableMatch = periodicTable.find(function (x) {
            return x.article == article.id;
          });

          article.periodicTableInfo = periodicTableMatch || {};

          article.periodicTableInfo.categoryColors = {};

          var categoryColors = colors.filter(function (color) {
            return color.category.trim().toLowerCase() == article.periodicTableInfo.category.trim().toLowerCase();
          });

          categoryColors.forEach(function (categoryColor) {
            if (categoryColor.area.trim().toLowerCase() == 'background')
              article.periodicTableInfo.categoryColors.background = categoryColor.value;

            if (categoryColor.area.trim().toLowerCase() == 'text')
              article.periodicTableInfo.categoryColors.text = categoryColor.value;
          });
        });
      },

      _transform: function (model) {
        var articles = [];
        var that = this;

        model.forEach(function (row, index) {
          var content = (row.articlecontent || '').match(/^(.*)$/mg);
          var name = 'Article ' + row.article;
          var article = articles.find(function (e) { return e.name === name; }) || articles.push({
            id: row.article,
            name: name,
            description: row.oversimplifieddescriptionarticlesandrecitals,
            articleContent: row.articlecontent.trim(),
            faqs: [],
            toBeCompliant: []
          }) && articles[articles.length - 1];

          if (row.faqs) {
            article.faqs.push({
              title: row.faqs.match(/^(.*)$/m)[0],
              description: row.faqs.replace(row.faqs.match(/^(.*)$/m)[0], '').trim()
            });
          }

          if (row.whatitmeansoutcomestobecompliantmodeltobecompliantmycompanycontrollermust) {
            article.toBeCompliant.push({
              content: row.whatitmeansoutcomestobecompliantmodeltobecompliantmycompanycontrollermust,
              contentHash: that.hashProvider.getHash(row.whatitmeansoutcomestobecompliantmodeltobecompliantmycompanycontrollermust),
              status1: row.status,
              status2: row.status2,
              status3: row.status3,
              status4: row.status4,
              status5: row.status5,
              status6: row.status6
            });
          }
        });

        return articles;
      },

      _countCompiledArticles: function (data) {
        var count = 0;
        data.forEach(function (article) {
          var completed = (article.toBeCompliant || [])
            .filter(function (e) {
              return ['na', 'n.a.'].indexOf(e.status.toLowerCase()) !== -1 || parseInt(e.status) === 100
            }).length;
          var total = article.toBeCompliant.length;

          if (total !== 0 && completed === total) count++;

        });

        return count;
      },

      _countChecklistItemsTotal: function () {
        return this._countChecklistItems(this.data).total;
      },

      _countChecklistItemsDone: function () {
        return this._countChecklistItems(this.data).done;
      },

      _countChecklistItems: function (data) {
        var total = 0;
        var done = 0;

        data.forEach(function (article) {
          var items = article.toBeCompliant;
          items.forEach(function (item) {
            if (['na', 'n.a.'].indexOf(item.status) === -1) total++;
            if (parseInt(item.status) === 100) done++;
          })
        });

        return {
          done: done,
          total: total
        };
      }

    });
  </script>
</dom-module>
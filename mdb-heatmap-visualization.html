<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../atom-google-sheet-adapter/atom-google-sheet-adapter.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="mdb-heatmap.html">

<!--
`mdb-heatmap-visualization`


@demo demo/index.html 
-->

<dom-module id="mdb-heatmap-visualization">
  <template>
    <style>
       :host {
        display: block;
      }

       :host .container {
        display: flex;
        justify-content: center;
        flex-wrap: nowrap;
      }

       :host .column {
        flex: 1;
        width: 33%;
        margin: var(--standard-padding, 20px);
      }

       :host .column.chart {
        background-color: #fff;
        padding: var(--standard-padding, 20px);
      }

       :host .article {
        background-color: #fff9c5;
        padding: var(--standard-padding, 20px);
      }

       :host .article h3 {
        padding-left: var(--standard-padding, 20px);
      }

       :host .article ol {
        padding-left: var(--standard-padding, 20px);
      }

       :host .article-term {
        margin-bottom: var(--standard-padding, 20px);
      }

       :host .toBeCompliant,
       :host .faq {
        padding: var(--standard-padding, 20px);
      }
    </style>
    <atom-google-sheet-adapter key="{{key}}"></atom-google-sheet-adapter>
    <div class="container">
      <div class="column chart">
        <h2>Your GDPR Story</h2>
        <mdb-heatmap data="[[data]]"></mdb-heatmap>
      </div>
      <div class="column">
        <paper-tabs selected="{{selectedTab}}">
          <paper-tab>TO BE COMPLIANT</paper-tab>
          <paper-tab>FAQS</paper-tab>
        </paper-tabs>
        <iron-pages selected="{{selectedTab}}">
          <div class="toBeCompliant">
            <template is="dom-repeat" items="[[selectedArticle.toBeCompliant]]">
              <template is="dom-if" if="[[item.content]]">
                <div>[[item.content]]</div>
              </template>
            </template>
          </div>
          <div class="faq">
            <template is="dom-repeat" items="[[selectedArticle.faqs]]">
              <h3>[[item.title]]</h3>
              <div>[[item.description]]</div>
            </template>
          </div>
        </iron-pages>
      </div>
      <div class="column">
        <template is="dom-if" if="[[selectedArticle]]">
          <div class="article">
            <h3>[[selectedArticle.description]]</h3>
            <h3>Article [[selectedArticle.name]]</h3>
            <h3>[[selectedArticle.articleContent.title]]</h3>
            <ol>
              <template is="dom-repeat" items="[[selectedArticle.articleContent.description]]">
                <li class="article-term">[[item]]</li>
              </template>
            </ol>
          </div>
        </template>
      </div>
    </div>
  </template>

  <script>
    Polymer({

      is: 'mdb-heatmap-visualization',

      properties: {
        key: {
          type: String,
          observer: '_keyChanged',
        },

        modelSheet: {
          type: String,
          value: 'heat-map'
        },

        glossarySheet: {
          type: String,
          value: 'Glossary'
        },

        data: {
          type: Array,
          value: [],
          observer: '_dataChanged'
        },

        selectedArticle: {
          type: Object,
          value: {}
        },

        selectedTab: {
          type: Number,
          value: 0
        }
      },

      _keyChanged: function () {
        if (this.key) {
          var that = this;
          this._fetchData()
            .then(function (data) {
              that.dataLoaded = true;
              setTimeout(function () {
                var model = data[0],
                  glossary = data[1];
                that.set('data', that._transform(model, glossary));
                that.selectedArticle = that.data[0];//Select first article by default
              }, 0);
            });
        }
      },

      _fetchData: function () {
        var that = this,
          adapter = this.querySelector('atom-google-sheet-adapter');

        return new Promise(function (resolve, reject) {
          adapter.read(that.modelSheet)
            .then(function (model) {
              adapter.read(that.glossarySheet)
                .then(function (glossary) {
                  resolve([model, glossary]);
                }).catch(function (error) {
                  reject(error);
                });
            }).catch(function (error) {
              reject(error);
            });
        });
      },

      _dataChanged: function () {
        var heatMap = this.querySelector('mdb-heatmap');
        if (heatMap) heatMap.render();
      },

      _transform: function (model, glossary) {
        var articles = [];

        model.forEach(function (row, index) {
          var content = (row.articlecontent || '').match(/^(.*)$/mg);
          var article = articles.find(function (e) { return e.name === row.article; }) || articles.push({
            name: row.article,
            description: row.oversimplifieddescriptionarticlesandrecitals,
            articleContent: {
              title: content[0],
              description: content.slice(1).filter(function (e) { return !!e; }).map(function (e) { return e.replace(/^\d+\./, '').trim(); })
            },
            faqs: [],
            toBeCompliant: []
          }) && articles[articles.length - 1];

          if (row.faqs) {
            // var description = row.faqs.replace(row.faqs.match(/^(.*)$/m)[0], '').trim();
            // glossary.forEach(function (g) {
            //   description = description.replace('{{' + g.term + '}}', g.definition);
            // });
            article.faqs.push({
              title: row.faqs.match(/^(.*)$/m)[0],
              description: row.faqs.replace(row.faqs.match(/^(.*)$/m)[0], '').trim()
            });
          }

          if (row.whatitmeansoutcomestobecompliantmodeltobecompliantmycompanycontrollermust) {
            article.toBeCompliant.push({
              content: row.whatitmeansoutcomestobecompliantmodeltobecompliantmycompanycontrollermust,
              status: row.status
            });
          }
        });

        return articles;
      }

    });
  </script>
</dom-module>
<link rel="import" href="../polymer/polymer.html">
<script src="../d3/d3.min.js"></script>

<dom-module id="mdb-heatmap">
    <template>
        <style>
             :host {
                display: block;
            }

             :host rect.bordered {
                stroke: #fff;
                stroke-width: 5px;
            }

             :host text.mono {
                font-size: 9pt;
                font-family: Consolas, courier;
                fill: #aaa;
            }

             :host text.axis-workweek {
                fill: #000;
            }

             :host text.axis-worktime {
                fill: #000;
            }
        </style>
        <div id="chart"></div>
    </template>

    <script>
        Polymer({
            is: 'mdb-heatmap',

            properties: {
                data: {
                    type: Array,
                    value: []
                }
            },

            ready: function () {
                this.scopeSubtree(this.$.chart, true);
            },

            attached: function () {
                this.svg = d3.select("#chart").append("svg")
                    // .attr("width", width + margin.left + margin.right)
                    // .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                // .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            },

            render: function () {
                var data = this.data
                    .map(function (e, i) {
                        return {
                            row: parseInt(i / 10),
                            col: i % 10,
                            status: parseInt(Math.random() * 100)
                        };
                    });
                this._render(data);
            },

            _render: function (data) {
                if (this.svg) {
                    var margin = { top: 50, right: 0, bottom: 100, left: 30 },
                        width = 600,
                        height = 600,
                        gridSize = Math.floor(width / 20),
                        legendElementWidth = gridSize * 2,
                        buckets = 9,
                        colors = ["#ffffd9", "#edf8b1", "#c7e9b4", "#7fcdbb", "#41b6c4", "#1d91c0", "#225ea8", "#253494", "#081d58"]; // alternatively colorbrewer.YlGnBu[9]

                    var colorScale = d3.scale.quantile()
                        .domain([0, buckets - 1, d3.max(data, function (d) { return d.status; })])
                        .range(colors);

                    var cards = this.svg.selectAll(".hour")
                        .data(data, function (d) { return d.row + ':' + d.col; });

                    cards.append("title");

                    cards.enter().append("rect")
                        .attr("x", function (d) { return (d.col) * gridSize; })
                        .attr("y", function (d) { return (d.row) * gridSize; })
                        .attr("rx", 4)
                        .attr("ry", 4)
                        .attr("class", "hour bordered")
                        .attr("width", gridSize)
                        .attr("height", gridSize)
                        .style("fill", colors[0]);

                    cards.transition().duration(1000)
                        .style("fill", function (d) { return colorScale(d.status); });

                    cards.select("title").text(function (d) { return d.status; });

                    cards.exit().remove();

                    var legend = this.svg.selectAll(".legend")
                        .data([0].concat(colorScale.quantiles()), function (d) { return d; });

                    legend.enter().append("g")
                        .attr("class", "legend");

                    legend.append("rect")
                        .attr("x", function (d, i) { return legendElementWidth * i; })
                        .attr("y", height)
                        .attr("width", legendElementWidth)
                        .attr("height", gridSize / 2)
                        .style("fill", function (d, i) { return colors[i]; });

                    legend.append("text")
                        .attr("class", "mono")
                        .text(function (d) { return "â‰¥ " + Math.round(d); })
                        .attr("x", function (d, i) { return legendElementWidth * i; })
                        .attr("y", height + gridSize);

                    legend.exit().remove();
                }
            }
        });
    </script>
</dom-module>
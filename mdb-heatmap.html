<link rel="import" href="../polymer/polymer.html">
<script src="../d3/d3.min.js"></script>

<dom-module id="mdb-heatmap">
    <template>
        <style>
             :host {
                display: block;
            }

             :host rect.bordered {
                stroke: #fff;
                stroke-width: 5px;
            }

             :host text.mono {
                font-size: 9pt;
                font-family: Consolas, courier;
                fill: #aaa;
            }

             :host text.axis-workweek {
                fill: #000;
            }

             :host text.axis-worktime {
                fill: #000;
            }
        </style>
        <div id="chart"></div>
    </template>

    <script>
        Polymer({
            is: 'mdb-heatmap',

            properties: {
                data: {
                    type: Array,
                    value: []
                }
            },

            ready: function () {
                this.scopeSubtree(this.$.chart, true);
            },

            attached: function () {
                this.svg = d3.select("#chart").append("svg")
                    // .attr("width", width + margin.left + margin.right)
                    // .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                // .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            },

            render: function () {
                var data = this.data
                    .map(function (e, i) {
                        e.row = parseInt(i / 10);
                        e.col = i % 10;
                        e.status = parseInt(Math.random() * 100);
                        return e;
                    });
                this._render(data);
            },

            _render: function (data) {
                if (this.svg) {
                    var that = this;
                    var margin = { top: 50, right: 0, bottom: 100, left: 30 },
                        width = 600,
                        height = 600,
                        gridSize = Math.floor(width / 20),
                        buckets = 5,
                        colors = ['#c8e6c9', '#a5d6a7', '#81c784', '#66bb6a', '#4caf50'];

                    var colorScale = d3.scale.quantile()
                        .domain([0, buckets - 1, d3.max(data, function (d) { return d.status; })])
                        .range(colors);

                    var cards = this.svg.selectAll(".hour")
                        .data(data, function (d) { return d.row + ':' + d.col; });

                    cards.append("title");

                    cards.enter().append("rect")
                        .attr("x", function (d) { return (d.col) * gridSize; })
                        .attr("y", function (d) { return (d.row) * gridSize; })
                        .attr("rx", 4)
                        .attr("ry", 4)
                        .attr("class", "hour bordered")
                        .attr("width", gridSize)
                        .attr("height", gridSize)
                        .style("fill", colors[0])
                        .on('click', function (data) {
                            //that._click.apply(that, arguments);
                            that.fire('article-changed', data);
                        })
                        .on("mouseover", function (d) {
                            var g = d3.select(this); // The node
                            // The class is used to remove the additional text later
                            var info = g.append('text')
                                .attr("class", "hover")
                                .text(d.name);
                        })
                        .on("mouseout", function () {
                            // Remove the info text on mouse out.
                            d3.select(this).select('text.hover').remove();
                        });

                    cards.transition().duration(1000)
                        .style("fill", function (d) { return colorScale(d.status); });

                    cards.select("title").text(function (d) { return d.status; });

                    cards.exit().remove();
                }
            }
        });
    </script>
</dom-module>